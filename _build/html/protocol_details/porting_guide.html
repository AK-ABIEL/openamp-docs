<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Porting GuideLine &mdash; OpenAMP  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/mystyle.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Resource Table Evolution" href="resource_tbl.html" />
    <link rel="prev" title="System Wide Considerations" href="system_considerations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> OpenAMP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../openamp/index.html">OpenAMP Project</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">OpenAMP Protocol Details</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="asymmetric_mp.html">Asymmetric Multiprocessing Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="components.html">Components and Capabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="rpmsg.html">RPMsg Messaging Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="rpmsg_comms.html">RPMsg Communication Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifecyclemgmt.html">Life Cycle Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_considerations.html">System Wide Considerations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Porting GuideLine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#add-system-machine-support-in-libmetal">Add System/Machine Support in Libmetal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#platform-specific-remoteproc-driver">Platform Specific Remoteproc Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#platform-specific-porting-to-use-remoteproc-to-manage-remote-processor">Platform Specific Porting to Use Remoteproc to Manage Remote Processor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#platform-specific-porting-to-use-rpmsg">Platform Specific Porting to Use RPMsg</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="resource_tbl.html">Resource Table Evolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="openamp_ci.html">Using OpenAMP CI</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenAMP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">OpenAMP Protocol Details</a> &raquo;</li>
      <li>Porting GuideLine</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/protocol_details/porting_guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="porting-guideline">
<span id="porting-guide-work-label"></span><h1>Porting GuideLine<a class="headerlink" href="#porting-guideline" title="Permalink to this heading"></a></h1>
<p>The OpenAMP Framework uses libmetal to provide abstractions that allow for porting of the OpenAMP Framework to various software environments (operating systems and bare metal environments) and machines (processors/platforms). To port OpenAMP for your platform, you will need to:</p>
<blockquote>
<div><ul class="simple">
<li><p>add your system environment support to libmetal,</p></li>
<li><p>implement your platform specific remoteproc driver.</p></li>
<li><p>define your shared memory layout and specify it in a resource table.</p></li>
</ul>
</div></blockquote>
<section id="add-system-machine-support-in-libmetal">
<h2>Add System/Machine Support in Libmetal<a class="headerlink" href="#add-system-machine-support-in-libmetal" title="Permalink to this heading"></a></h2>
<p>User will need to add system/machine support to lib/system/&lt;SYS&gt;/ directory in libmetal repository. OpenAMP requires the following libmetal primitives:</p>
<blockquote>
<div><ul class="simple">
<li><p>alloc, for memory allocation and memory free</p></li>
<li><p>io, for memory mapping. OpenAMP required memory mapping in order to access vrings and carved out memory.</p></li>
<li><p>mutex</p></li>
<li><p>sleep, at the moment, OpenAMP only requires microseconds sleep as when OpenAMP fails to get a buffer to send messages, it will call this function to sleep and then try again.</p></li>
<li><p>init, for libmetal initialization.</p></li>
</ul>
</div></blockquote>
<p>Please refer to lib/system/generic/ when adding RTOS support to libmetal.</p>
<p>libmetal uses C11/C++11 stdatomics interface for atomic operations, if you use a different compiler to GNU gcc, you may need to implement the atomic operations defined in lib/compiler/gcc/atomic.h.</p>
</section>
<section id="platform-specific-remoteproc-driver">
<h2>Platform Specific Remoteproc Driver<a class="headerlink" href="#platform-specific-remoteproc-driver" title="Permalink to this heading"></a></h2>
<p>User will need to implement platform specific remoteproc driver to use remoteproc life cycle management APIs. The remoteproc driver platform specific functions are defined in this file: lib/include/openamp/remoteproc.h. Here are the remoteproc functions needs platform specific implementation.</p>
<blockquote>
<div><ul class="simple">
<li><p>init(), instantiate the remoteproc instance with platform specific config parameters.</p></li>
<li><p>remove(), destroy the remoteproc instance and its resource.</p></li>
<li><p>mmap(), map the memory speficified with physical address or remote device address so that it can be used by the application.</p></li>
<li><p>handle_rsc(), handler to the platform specific resource which is specified in the resource table.</p></li>
<li><p>config(), configure the remote processor to get it ready to load application.</p></li>
<li><p>start(), start the remote processor to run the application.</p></li>
<li><p>stop(), stop the remote processor from running but not power it down.</p></li>
<li><p>shutdown(), shutdown the remote processor and you can power it down.</p></li>
<li><p>notify(), notify the remote processor.</p></li>
</ul>
</div></blockquote>
</section>
<section id="platform-specific-porting-to-use-remoteproc-to-manage-remote-processor">
<h2>Platform Specific Porting to Use Remoteproc to Manage Remote Processor<a class="headerlink" href="#platform-specific-porting-to-use-remoteproc-to-manage-remote-processor" title="Permalink to this heading"></a></h2>
<p>User will need to implement the above platform specific remoteproc driver functions. After that, user can use remoteproc APIs to run application on a remote processor. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;openamp/remoteproc.h&gt;</span>

<span class="o">/*</span> <span class="n">User</span> <span class="n">defined</span> <span class="n">remoteproc</span> <span class="n">operations</span> <span class="o">*/</span>
<span class="n">extern</span> <span class="n">struct</span> <span class="n">remoteproc_ops</span> <span class="n">rproc_ops</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">User</span> <span class="n">defined</span> <span class="n">image</span> <span class="n">store</span> <span class="n">operations</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">image</span> <span class="n">file</span><span class="p">,</span> <span class="n">read</span>
 <span class="o">*</span> <span class="n">image</span> <span class="kn">from</span> <span class="nn">storage</span><span class="p">,</span> <span class="ow">and</span> <span class="n">close</span> <span class="n">the</span> <span class="n">image</span> <span class="n">file</span><span class="o">.</span>
 <span class="o">*/</span>

<span class="n">extern</span> <span class="n">struct</span> <span class="n">image_store_ops</span> <span class="n">img_store_ops</span><span class="p">;</span>
<span class="o">/*</span> <span class="n">Pointer</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">image</span> <span class="n">store</span> <span class="n">information</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">user</span>
 <span class="o">*</span> <span class="n">defined</span> <span class="n">image</span> <span class="n">store</span> <span class="n">operations</span> <span class="n">by</span> <span class="n">the</span> <span class="n">remoteproc</span> <span class="n">loading</span> <span class="n">application</span>
 <span class="o">*</span> <span class="n">function</span><span class="o">.</span> <span class="n">Its</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">defined</span> <span class="n">by</span> <span class="n">user</span><span class="o">.</span>
 <span class="o">*/</span>
<span class="n">void</span> <span class="o">*</span><span class="n">img_store_info</span><span class="p">;</span>

<span class="n">struct</span> <span class="n">remoteproc</span> <span class="n">rproc</span><span class="p">;</span>

<span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
      <span class="o">/*</span> <span class="n">Instantiate</span> <span class="n">the</span> <span class="n">remoteproc</span> <span class="n">instance</span> <span class="o">*/</span>
      <span class="n">remoteproc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rproc_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">private_data</span><span class="p">);</span>

      <span class="o">/*</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="k">if</span> <span class="n">user</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">before</span>
       <span class="o">*</span> <span class="n">loading</span> <span class="n">applications</span><span class="o">.</span>
       <span class="o">*/</span>
      <span class="n">remoteproc_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_config</span><span class="p">);</span>

      <span class="o">/*</span> <span class="n">Load</span> <span class="n">Application</span><span class="o">.</span> <span class="n">It</span> <span class="n">only</span> <span class="n">supports</span> <span class="n">ELF</span> <span class="k">for</span> <span class="n">now</span><span class="o">.</span> <span class="o">*/</span>
      <span class="n">remoteproc_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">,</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">img_store_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_store_ops</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>

      <span class="o">/*</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">processor</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">application</span><span class="o">.</span> <span class="o">*/</span>
      <span class="n">remoteproc_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">);</span>

      <span class="o">/*</span> <span class="o">...</span> <span class="o">*/</span>

      <span class="o">/*</span> <span class="n">Optional</span><span class="o">.</span> <span class="n">Stop</span> <span class="n">the</span> <span class="n">processor</span><span class="p">,</span> <span class="n">but</span> <span class="n">the</span> <span class="n">processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">powered</span>
       <span class="o">*</span> <span class="n">down</span><span class="o">.</span>
       <span class="o">*/</span>
      <span class="n">remoteproc_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">);</span>

      <span class="o">/*</span> <span class="n">Shutdown</span> <span class="n">the</span> <span class="n">processor</span><span class="o">.</span> <span class="n">The</span> <span class="n">processor</span> <span class="ow">is</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">powered</span>
       <span class="o">*</span> <span class="n">down</span><span class="o">.</span>
       <span class="o">*/</span>
      <span class="n">remoteproc_shutdown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">);</span>

      <span class="o">/*</span> <span class="n">Destroy</span> <span class="n">the</span> <span class="n">remoteproc</span> <span class="n">instance</span> <span class="o">*/</span>
      <span class="n">remoteproc_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="platform-specific-porting-to-use-rpmsg">
<h2>Platform Specific Porting to Use RPMsg<a class="headerlink" href="#platform-specific-porting-to-use-rpmsg" title="Permalink to this heading"></a></h2>
<p>RPMsg in OpenAMP implementation uses VirtIO to manage the shared buffers. OpenAMP library provides remoteproc VirtIO backend implementation. You don’t have to use remoteproc backend. You can implement your VirtIO backend with the VirtIO and RPMsg implementation in OpenAMP. If you want to implement your own VirtIO backend, you can refer to the [remoteproc VirtIO backend implementation]: <a class="reference external" href="https://github.com/OpenAMP/open-amp/blob/master/lib/remoteproc/remoteproc_virtio.c">https://github.com/OpenAMP/open-amp/blob/master/lib/remoteproc/remoteproc_virtio.c</a></p>
<p>Here are the steps to use OpenAMP for RPMsg communication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;openamp/remoteproc.h&gt;
#include &lt;openamp/rpmsg.h&gt;
#include &lt;openamp/rpmsg_virtio.h&gt;

/* User defined remoteproc operations for communication */
sturct remoteproc rproc_ops = {
      .init = local_rproc_init;
      .mmap = local_rproc_mmap;
      .notify = local_rproc_notify;
      .remove = local_rproc_remove;
};

/* Remoteproc instance. If you don&#39;t use Remoteproc VirtIO backend,
 * you don&#39;t need to define the remoteproc instance.
 */
struct remoteproc rproc;

/* RPMsg VirtIO device instance. */
struct rpmsg_virtio_device rpmsg_vdev;

/* RPMsg device */
struct rpmsg_device *rpmsg_dev;

/* Resource Table. Resource table is used by remoteproc to describe
 * the shared resources such as vdev(VirtIO device) and other shared memory.
 * Resource table resources definition is in the remoteproc.h.
 * Examples of the resource table can be found in the OpenAMP repo:
 *  - apps/machine/zynqmp/rsc_table.c
 *  - apps/machine/zynqmp_r5/rsc_table.c
 *  - apps/machine/zynq7/rsc_table.c
 */
void *rsc_table = &amp;resource_table;

/* Size of the resource table */
int rsc_size = sizeof(resource_table);

/* Shared memory metal I/O region. It will be used by OpenAMP library
 * to access the memory. You can have more than one shared memory regions
 * in your application.
 */
struct metal_io_region *shm_io;

/* VirtIO device */
struct virtio_device *vdev;

/* RPMsg shared buffers pool */
struct rpmsg_virtio_shm_pool shpool;

/* Shared buffers */
void *shbuf;

/* RPMsg endpoint */
struct rpmsg_endpoint ept;

/* User defined RPMsg name service callback. This callback is called
 * when there is no registered RPMsg endpoint is found for this name
 * service. User can create RPMsg endpoint in this callback. */
void ns_bind_cb(struct rpmsg_device *rdev, const char *name, uint32_t dest);

/* User defined RPMsg endpoint received message callback */
void rpmsg_ept_cb(struct rpmsg_endpoint *ept, void *data, size_t len,
                uint32_t src, void *priv);

/* User defined RPMsg name service unbind request callback */
void ns_unbind_cb(struct rpmsg_device *rdev, const char *name, uint32_t dest);

void main(void)
{
      /* Instantiate remoteproc instance */
      remoteproc_init(&amp;rproc, &amp;rproc_ops);

      /* Mmap shared memories so that they can be used */
      remoteproc_mmap(&amp;rproc, &amp;physical_address, NULL, size,
                      &lt;memory_attributes&gt;, &amp;shm_io);

      /* Parse resource table to remoteproc */
      remoteproc_set_rsc_table(&amp;rproc, rsc_table, rsc_size);

      /* Create VirtIO device from remoteproc.
       * VirtIO device master will initiate the VirtIO rings, and assign
       * shared buffers. If you running the application as VirtIO slave, you
       * set the role as VIRTIO_DEV_SLAVE.
       * If you don&#39;t use remoteproc, you will need to define your own VirtIO
       * device.
       */
      vdev = remoteproc_create_virtio(&amp;rproc, 0, VIRTIO_DEV_MASTER, NULL);

      /* This step is only required if you are VirtIO device master.
       * Initialize the shared buffers pool.
       */
      shbuf = metal_io_phys_to_virt(shm_io, SHARED_BUF_PA);
      rpmsg_virtio_init_shm_pool(&amp;shpool, shbuf, SHARED_BUFF_SIZE);

      /* Initialize RPMsg VirtIO device with the VirtIO device */
      /* If it is VirtIO device slave, it will not return until the master
       * side set the VirtIO device DRIVER OK status bit.
       */
      rpmsg_init_vdev(&amp;rpmsg_vdev, vdev, ns_bind_cb, io, shm_io, &amp;shpool);

      /* Get RPMsg device from RPMsg VirtIO device */
      rpmsg_dev = rpmsg_virtio_get_rpmsg_device(&amp;rpmsg_vdev);

      /* Create RPMsg endpoint. */
      rpmsg_create_ept(&amp;ept, rdev, RPMSG_SERVICE_NAME, RPMSG_ADDR_ANY,
                       rpmsg_ept_cb, ns_unbind_cb);

      /* If it is VirtIO device master, it sends the first message */
      while (!is_rpmsg_ept_read(&amp;ept)) {
              /* check if the endpoint has binded.
               * If not, wait for notification. If local endpoint hasn&#39;t
               * been bound with the remote endpoint, it will fail to
               * send the message to the remote.
               */
              /* If you prefer to use interrupt, you can wait for
               * interrupt here, and call the VirtIO notified function
               * in the interrupt handling task.
               */
              rproc_virtio_notified(vdev, RSC_NOTIFY_ID_ANY);
      }
      /* Send RPMsg */
      rpmsg_send(&amp;ept, data, size);

      do {
              /* If you prefer to use interrupt, you can wait for
               * interrupt here, and call the VirtIO notified function
               * in the interrupt handling task.
               * If vdev is notified, the endpoint callback will be
               * called.
               */
              rproc_virtio_notified(vdev, RSC_NOTIFY_ID_ANY);
      } while(!ns_unbind_cb_is_called &amp;&amp; !user_decided_to_end_communication);

      /* End of communication, destroy the endpoint */
      rpmsg_destroy_ept(&amp;ept);

      rpmsg_deinit_vdev(&amp;rpmsg_vdev);

      remoteproc_remove_virtio(&amp;rproc, vdev);

      remoteproc_remove(&amp;rproc);
}
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="system_considerations.html" class="btn btn-neutral float-left" title="System Wide Considerations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="resource_tbl.html" class="btn btn-neutral float-right" title="Resource Table Evolution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, OpenAMP Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>